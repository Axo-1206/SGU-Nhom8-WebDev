export const market = {
  "Toán và lập trình": {
    hidden: false,
    items: [
      {
        id: 1,
        name: "Toán",
        price: "45",
        image: "https://toanmath.com/wp-content/uploads/2024/02/sach-giao-khoa-toan-12-tap-1-ket-noi-tri-thuc-voi-cuoc-song.png",
        active: true,
        description: "Giáo trình Toán lớp 12 giúp học sinh nắm vững kiến thức nền tảng.",
        quantity: 18,
        releaseYear: 2024,
        cost_price: 36
      },
      {
        id: 2,
        name: "Giải tích 1",
        price: "85",
        image: "../assets/images/vantai.png",
        active: true,
        description: "Khám phá các khái niệm giới hạn, đạo hàm và tích phân.",
        quantity: 10,
        releaseYear: 2023,
        cost_price: 68
      },
      {
        id: 3,
        name: "Xác suất thống kê",
        price: "30",
        image: "../assets/images/nguyenvantaingu.png",
        active: true,
        description: "Tài liệu cơ bản về xác suất và thống kê ứng dụng.",
        quantity: 22,
        releaseYear: 2022,
        cost_price: 24
      },
      {
        id: 4,
        name: "Lý thuyết đồ thị",
        price: "45",
        image: "../assets/images/ltđt.png",
        active: true,
        description: "Giới thiệu các khái niệm và thuật toán trong đồ thị.",
        quantity: 15,
        releaseYear: 2021,
        cost_price: 36
      },
      {
        id: 5,
        name: "Toán rời rạc",
        price: "45",
        image: "../assets/images/toanroirac.png",
        active: true,
        description: "Phân tích các cấu trúc toán học không liên tục.",
        quantity: 12,
        releaseYear: 2022,
        cost_price: 36
      },
      {
        id: 6,
        name: "Cơ sở dữ liệu",
        price: "90",
        image: "../assets/images/csdl.png",
        active: true,
        description: "Hướng dẫn thiết kế và quản lý hệ thống cơ sở dữ liệu.",
        quantity: 7,
        releaseYear: 2022,
        cost_price: 72
      },
      {
        id: 7,
        name: "Cấu trúc dữ liệu và giải thuật",
        price: "40",
        image: "../assets/images/cautrucduulieuvagiaithuat.png",
        active: true,
        description: "Tài liệu chuyên sâu về cấu trúc dữ liệu và thuật toán.",
        quantity: 16,
        releaseYear: 2023,
        cost_price: 32
      },
      {
        id: 8,
        name: "Kỹ thuật lập trình C",
        price: "15",
        image: "../assets/images/ktltC.png",
        active: true,
        description: "Giáo trình nhập môn lập trình với các ví dụ thực tế.",
        quantity: 25,
        releaseYear: 2025,
        cost_price: 12
      },
      {
        id: 9,
        name: "Lập trình Java cơ bản",
        price: "45",
        image: "../assets/images/ltjavacanban.png",
        active: true,
        description: "Học lập trình Java từ cơ bản.",
        quantity: 14,
        releaseYear: 2021,
        cost_price: 36
      },
      {
        id: 10,
        name: "Lập trình hướng đối tượng java",
        price: "85",
image: "../assets/images/lthdtjava.png",
        active: true,
        description: "Giáo trình OOP với ví dụ minh họa bằng Java và C++.",
        quantity: 11,
        releaseYear: 2023,
        cost_price: 68
      },
      {
        id: 11,
        name: "Bài tập JavaScript",
        price: "30",
        image: "../assets/images/baitapjavascript.png",
        active: true,
        description: "Tài liệu học JavaScript cho phát triển web hiện đại.",
        quantity: 19,
        releaseYear: 2024,
        cost_price: 24
      },
      {
        id: 12,
        name: "C++",
        price: "45",
        image: "../assets/images/cpp.png",
        active: true,
        description: "Giáo trình C++ với các bài tập thực hành nâng cao.",
        quantity: 13,
        releaseYear: 2022,
        cost_price: 36
      },
      {
        id: 13,
        name: "Python",
        price: "85",
        image: "../assets/images/python.png",
        active: true,
        description: "Giáo trình Python dành cho phân tích dữ liệu và AI.",
        quantity: 9,
        releaseYear: 2024,
        cost_price: 68
      },
      {
        id: 14,
        name: "C#",
        price: "30",
        image: "../assets/images/cs.png",
        active: true,
        description: "Hướng dẫn lập trình C# với ứng dụng thực tế.",
        quantity: 17,
        releaseYear: 2021,
        cost_price: 24
      },
      {
        id: 15,
        name: "Kiến trúc máy tính",
        price: "30",
        image: "../assets/images/ktmt.png",
        active: true,
        description: "Nguyên cứu về bên trong máy tính",
        quantity: 17,
        releaseYear: 2021,
        cost_price: 24
      },
      {
        id: 16,
        name: "Mạng máy tính",
        price: "30",
        image: "../assets/images/mmmt.png",
        active: true,
        description: "Nguyên cứu về hệ thống mạng máy tính",
        quantity: 17,
        releaseYear: 2021,
        cost_price: 24
      },
      {
        id: 17,
        name: "Phát triển ứng dụng",
        price: "30",
        image: "../assets/images/ppungdung.png",
        active: true,
        description: "Nguyên cứu về cách tạo ứng dụng",
        quantity: 17,
        releaseYear: 2021,
        cost_price: 24
      },
      {
        id: 18,
        name: "Hợp ngữ",
        price: "30",
        image: "../assets/images/hopngu.png",
        active: true,
        description: "Tổng quan về hợp ngữ",
        quantity: 17,
        releaseYear: 2021,
        cost_price: 24
      },


    ]
  },

  "Triết và chính trị": {
    hidden: false,
    items: [
      {
        id: 19,
        name: "Triết học",
        price: "85",
        image: "../assets/images/triet.png",
        active: true,
        description: "Tổng quan các trường phái triết học phương Tây và phương Đông.",
        quantity: 8,
        releaseYear: 2020,
cost_price: 68
      },
      {
        id: 20,
        name: "Pháp luật đại cương",
        price: "30",
        image: "../assets/images/pldc.png",
        active: true,
        description: "Cẩm nang pháp luật cơ bản dành cho sinh viên.",
        quantity: 20,
        releaseYear: 2023,
        cost_price: 24
      },
      {
        id: 21,
        name: "Cờ tướng",
        price: "30",
        image: "../assets/images/vodichthu.png",
        active: true,
        description: "Chiến thuật và kỹ năng chơi cờ tướng chuyên sâu.",
        quantity: 30,
        releaseYear: 2021,
        cost_price: 24
      },
      {
        id: 22,
        name: "Kinh tế chính trị",
        price: "45",
        image: "../assets/images/ktct.png",
        active: true,
        description: "Phân tích các học thuyết kinh tế và chính trị hiện đại.",
        quantity: 14,
        releaseYear: 2024,
        cost_price: 36
      },
      {
        id: 23,
        name: "Chủ nghĩa xã hội và khoa học",
        price: "45",
        image: "../assets/images/cnxhvakh.png",
        active: true,
        description: "Phân tích các học thuyết về chủ nghĩa xã hội",
        quantity: 14,
        releaseYear: 2024,
        cost_price: 36
      },
      {
        id: 24,
        name: "Lịch sử đảng",
        price: "85",
        image: "../assets/images/lichsudang.png",
        active: true,
        description: "Lịch sử đảng cộng sản việt nam",
        quantity: 8,
        releaseYear: 2020,
        cost_price: 68
      },
      {
        id: 25,
        name: "Nguyên lý chủ nghĩa mac-lênin",
        price: "85",
        image: "../assets/images/nguyenlycnmln.png",
        active: true,
        description: "Nguyên lý chủ nghĩa mac-lênin",
        quantity: 8,
        releaseYear: 2020,
        cost_price: 68
      },
      {
        id: 26,
        name: "Đường lối cách mạng Việt Nam",
        price: "85",
        image: "../assets/images/duongloicachmang.png",
        active: true,
        description: "Phân tích về đường lối cách mạng Việt Nam",
        quantity: 8,
        releaseYear: 2020,
        cost_price: 68
      },


    ]
  },

  "Ngôn ngữ học": {
    hidden: false,
    items: [
      {
        id: 27,
        name: "Tiếng anh A1",
        price: "85",
        image: "../assets/images/taa1.png",
        active: true,
        description: "Dành cho học phần tiếng anh A1",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 28,
        name: "Tiếng anh A2",
        price: "85",
        image: "../assets/images/taa2.png",
        active: true,
        description: "Dành cho học phần tiếng anh A2",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 29,
        name: "Tiếng anh B1",
        price: "85",
        image: "../assets/images/tab1.png",
active: true,
        description: "Dành cho học phần tiếng anh B1",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 30,
        name: "Tiếng anh B2",
        price: "85",
        image: "../assets/images/tab2.png",
        active: true,
        description: "Dành cho học phần tiếng anh B2",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 31,
        name: "Tiếng anh C1",
        price: "85",
        image: "../assets/images/tac1.png",
        active: true,
        description: "Dành cho học phần tiếng anh C1",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 32,
        name: "Học tiếng trung",
        price: "85",
        image: "../assets/images/learnchinese.png",
        active: true,
        description: "Học tiếng trung, bingchiling",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 33,
        name: "Học tiếng nhật",
        price: "85",
        image: "../assets/images/learnjapan.png",
        active: true,
        description: "Oni-chan baka",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 34,
        name: "Học tiếng hàn",
        price: "85",
        image: "../assets/images/learnkorean.png",
        active: true,
        description: "Học tiếng hàn",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 35,
        name: "Học tiếng việt",
        price: "85",
        image: "../assets/images/learnvn.png",
        active: true,
        description: "Học tiếng việt",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 36,
        name: "Học tiếng pháp",
        price: "85",
        image: "../assets/images/learnfrench.png",
        active: true,
        description: "Học tiếng pháp",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 37,
        name: "Học tiếng đức",
        price: "85",
        image: "../assets/images/learngerman.png",
        active: true,
        description: "Học tiếng đức",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
    ]
  },

  "Kế toán, doanh nghiệp": {
    hidden: false,
    items: [
      {
        id: 38,
        name: "Nguyên lý kế toán",
        price: "85",
        image: "../assets/images/nlketoan.png",
        active: true,
        description: "Nguyên cứu kế toán",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 39,
        name: "Kế toán, tài chính doanh nghiệp",
        price: "85",
        image: "../assets/images/tcdn.png",
        active: true,
description: "Nguyên cứu kế toán, tài chính doanh nghiệp",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 40,
        name: "Chính sách thuế",
        price: "85",
        image: "../assets/images/thue.png",
        active: true,
        description: "Nguyên cứu về thuế doanh nghiệp",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 41,
        name: "Nghiệp vụ ngân hàng",
        price: "85",
        image: "../assets/images/nvnganhang.png",
        active: true,
        description: "Nguyên cứu về nghiệp vụ ngân hàng",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 42,
        name: "Phân tích chứng khoáng",
        price: "85",
        image: "../assets/images/phantichck.png",
        active: true,
        description: "Phân tích về chứng khoáng",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 43,
        name: "Tài chính tiền tệ",
        price: "85",
        image: "../assets/images/tctt.png",
        active: true,
        description: "Phân tích về tài chính và tiền tệ",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 44,
        name: "Kế toán hành chính sự nghiệp",
        price: "85",
        image: "../assets/images/ketoanhcsp.png",
        active: true,
        description: "Phân tích về kế toán hành chính sự nghiệp",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 45,
        name: "Tài chính doanh nghiệp",
        price: "85",
        image: "../assets/images/taichinhdoanhnghiep.png",
        active: true,
        description: "Phân tích về tài chính của doanh nghiệp",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 46,
        name: "Tài chính quốc tế",
        price: "85",
        image: "../assets/images/taichinhquocte.png",
        active: true,
        description: "Phân tích về tài chính quốc tế",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 47,
        name: "Kinh tế phát triển",
        price: "85",
        image: "../assets/images/kinhtephattrien.png",
        active: true,
        description: "Phân tích về sự phát triển kinh tế",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 48,
        name: "Kiểm toán",
        price: "85",
        image: "../assets/images/kiemtoan.png",
        active: true,
        description: "Phân tích về kiểm toán",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 49,
        name: "Kinh tế học vĩ mô",
        price: "85",
        image: "../assets/images/kthvimo.png",
active: true,
        description: "Phân tích về kinh tế học",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },
      {
        id: 50,
        name: "Tài chính học",
        price: "85",
        image: "../assets/images/taichinhhoc.png",
        active: true,
        description: "Phân tích về tài chính",
        quantity: 8,
        releaseYear: 2012,
        cost_price: 68
      },


    ]
  }
};

// Hàm tạo ID duy nhất cho sản phẩm
function generateId(name) {
    return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
}

export function formatK(price) {
  if (price === null || price === undefined || price === '') return '0k';

  // Xử lý nếu đầu vào là số 
  if (typeof price === 'number') {
      // Làm tròn tối đa 2 số lẻ để tránh lỗi số
      const rounded = Math.round(price * 100) / 100; 
      return `${rounded}k`;
  }

  const str = String(price);
  const cleanStr = str.replace(/[^0-9.]/g, '');
  
  let num = parseFloat(cleanStr);
  if (isNaN(num)) num = 0;

  return `${num}k`;
}

// Thêm sản phẩm vào giỏ hàng (sử dụng trong module marketController)
function addToCart(item, quantity = 1) {
  if (!item) return;
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const id = generateId(item.name);
  const existingIndex = cart.findIndex(i => i.id === id);
  if (existingIndex !== -1) {
    cart[existingIndex].quantity += quantity;
  } else {
    cart.push({
      id,
      name: item.name,
      price: item.price,
      image: item.image,
      description: item.description,
      quantity: quantity
    });
  }
  localStorage.setItem('cart', JSON.stringify(cart));
  // Cập nhật hiển thị giỏ hàng ngay
  updateCartDisplay();
  
  // Cập nhật badge (lấy từ navbar.js)
  if (window.updateCartBadge) {
    window.updateCartBadge();
  }
}

// ===== CART FUNCTIONS (DI CHUYỂN TỪ NAVBAR.JS) =====

// Hàm cập nhật badge giỏ hàng
window.updateCartBadge = function() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    
    // Cập nhật badge sticky
    const floatingBadge = document.getElementById('floating-cart-badge');
    if (floatingBadge) {
        floatingBadge.textContent = totalItems;
        floatingBadge.style.display = totalItems > 0 ? 'flex' : 'none';
    }
};

// Hàm hiển thị giỏ hàng
window.showCart = function() {
    const cartContainer = document.querySelector('.cart-container');
    const cartOverlay = document.querySelector('.cart-overlay');

    if (cartContainer && cartOverlay) {
        cartOverlay.style.display = 'block';
        cartContainer.style.display = 'flex'; 
        
        setTimeout(() => {
            cartContainer.classList.add('active');
        }, 10);
        
        updateCartDisplay(); 
    }
};

// Lắng nghe thay đổi giỏ hàng từ các tab khác
window.addEventListener('storage', function(e) {
    if (e.key === 'cart') {
        updateCartBadge();
    }
});

// ===== KẾT THÚC CART FUNCTIONS =====

// Hàm đóng giỏ hàng
window.closeCart = function() {
    const cartContainer = document.querySelector('.cart-container');
    const cartOverlay = document.querySelector('.cart-overlay');
    if (cartContainer) cartContainer.style.display = 'none';
    if (cartOverlay) cartOverlay.style.display = 'none';
};

// Hàm cập nhật hiển thị giỏ hàng
window.updateCartDisplay = function() {
    const cartContainer = document.querySelector('.cart-container');
    const cartOverlay = document.querySelector('.cart-overlay');
    const cartItems = document.querySelector('.cart-items');
    const totalAmount = document.getElementById('total-amount');
    
    if (!cartContainer || !cartItems || !totalAmount) return;
    
    // Hiển thị overlay và container
    if (cartOverlay) cartOverlay.style.display = 'block';
    cartContainer.style.display = 'block';
    
    // Lấy giỏ hàng từ localStorage
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <p>Giỏ hàng của bạn đang trống</p>
            </div>`;
        totalAmount.textContent = formatK(0);
        return;
    }
    
    // Tính tổng (theo đơn vị 'k') và hiển thị danh sách sản phẩm
    let totalK = 0;
    cartItems.innerHTML = cart.map((item, index) => {
        const itemK = parseInt(String(item.price).replace(/[^\d]/g, ''), 10) || 0;
        totalK += itemK * item.quantity;

        // ===== BẮT ĐẦU SỬA: Thêm Nút Tăng/Giảm Số Lượng =====
        return `
          <div class="cart-item">
            <img src="${item.image}" alt="${item.name}" class="cart-item-image">
            <div class="cart-item-details">
              <h3>${item.name}</h3>
              
              <div class="quantity-controls" style="justify-content: center; gap: 10px; margin: 5px 0;">
                  <button class="quantity-btn" onclick="decreaseCartItem(${index})">-</button>
                  <span class="quantity-display" style="min-width: 30px; text-align: center;">${item.quantity}</span>
                  <button class="quantity-btn" onclick="increaseCartItem(${index})">+</button>
              </div>
              <p>Giá: ${formatK(item.price)}</p>
            </div>
            <button class="remove-item" onclick="removeFromCart(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        // ===== KẾT THÚC SỬA =====

    }).join('');

    // Hiển thị tổng tiền theo 'k'
    totalAmount.textContent = formatK(totalK);

    // Hiển thị giỏ hàng
    cartContainer.style.display = 'block';
}

// Hàm xóa sản phẩm khỏi giỏ hàng
window.removeFromCart = function(index) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartDisplay();
    
    // Cập nhật badge (lấy từ navbar.js)
    if (window.updateCartBadge) {
        window.updateCartBadge();
    }
};

// ===== BẮT ĐẦU THÊM MỚI: Hàm cập nhật số lượng =====

/**
 * Hàm tăng số lượng của item trong giỏ hàng
 * @param {number} index - Vị trí của item trong mảng cart
 */
window.increaseCartItem = function(index) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart[index]) {
        // Bạn có thể thêm logic kiểm tra số lượng tồn kho (quantity) ở đây nếu muốn
        cart[index].quantity += 1;
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Cập nhật lại giao diện
        updateCartDisplay();
        if (window.updateCartBadge) window.updateCartBadge();
    }
};

/**
 * Hàm giảm số lượng của item trong giỏ hàng
 * @param {number} index - Vị trí của item trong mảng cart
 */
window.decreaseCartItem = function(index) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart[index]) {
        cart[index].quantity -= 1;
        
        // Nếu số lượng giảm về 0, xóa item khỏi giỏ hàng
        if (cart[index].quantity <= 0) {
            cart.splice(index, 1);
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Cập nhật lại giao diện
        updateCartDisplay();
        if (window.updateCartBadge) window.updateCartBadge();
    }
};

// ===== QR Payment Modal Functions =====
let countdownInterval = null;
const COUNTDOWN_SECONDS = 300; // 5 minutes

window.showQRModal = function(qrImageUrl = null) {
    const qrModal = document.getElementById('qrModal');
    const qrImage = document.getElementById('qr-image');
    const countdownEl = document.getElementById('countdown-time');
    const statusEl = document.getElementById('paymentStatus');
    
    if (!qrModal) return;
    
    // Set QR image
    if (qrImageUrl) {
        qrImage.src = qrImageUrl;
    } else {
        if (!qrImage.src || qrImage.src.trim() === '') {
            qrImage.src = 'https://via.placeholder.com/250?text=QR+Code'; // Placeholder
        }
    }

    if (qrImage) {
        qrImage.onload = () => {
            if (statusEl) {
                statusEl.textContent = 'Đang chờ thanh toán...';
                statusEl.style.color = '#666';
            }
            qrImage.style.opacity = '1';
        };
        qrImage.onerror = () => {
            if (statusEl) {
                statusEl.textContent = 'Không thể tải ảnh QR. Vui lòng kiểm tra đường dẫn.';
                statusEl.style.color = '#ff6b6b';
            }
            try {
                qrImage.src = '../assets/images/nhom.png';
            } catch (e) { /* ignore */ }
            qrImage.style.opacity = '0.9';
        };
    }
    
    // Reset countdown
    if (countdownInterval) clearInterval(countdownInterval);
    let remainingSeconds = COUNTDOWN_SECONDS;
    
    // Update countdown every second
    const updateCountdown = () => {
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;
        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remainingSeconds <= 60) {
            countdownEl.style.color = '#ff6b6b';
        } else {
            countdownEl.style.color = '#8b14f9';
        }
        
        if (remainingSeconds > 0) {
            remainingSeconds--;
        } else {
            clearInterval(countdownInterval);
            statusEl.textContent = 'Hết thời gian! Thanh toán không thành công.';
            statusEl.style.color = '#ff6b6b';
            document.querySelector('.cancel-payment-btn').textContent = 'Đóng';
        }
    };
    
    updateCountdown(); // Initial display
    countdownInterval = setInterval(updateCountdown, 1000);
    
    // Show modal
    qrModal.style.display = 'flex';
    
    const confirmBtn = document.querySelector('.confirm-payment-btn');
    if (confirmBtn) {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Xác nhận đã thanh toán';
    }
    
    // Hide cart
    const cartContainer = document.querySelector('.cart-container');
    const cartOverlay = document.querySelector('.cart-overlay');
    if (cartContainer) cartContainer.style.display = 'none';
    if (cartOverlay) cartOverlay.style.display = 'none';
};

window.closeQRModal = function() {
    const qrModal = document.getElementById('qrModal');
    if (qrModal) qrModal.style.display = 'none';
    if (countdownInterval) clearInterval(countdownInterval);
};

window.cancelPayment = function() {
    const qrModal = document.getElementById('qrModal');
    const countdownEl = document.getElementById('countdown-time');
    const statusEl = document.getElementById('paymentStatus');
    
    if (countdownInterval) clearInterval(countdownInterval);
    
    // Reset modal
    countdownEl.style.color = '#8b14f9';
    countdownEl.textContent = '5:00';
    statusEl.textContent = 'Đang chờ thanh toán...';
    statusEl.style.color = '#666';
    document.querySelector('.cancel-payment-btn').textContent = 'Hủy thanh toán';
    const confirmBtn = document.querySelector('.confirm-payment-btn');
    if (confirmBtn) { confirmBtn.disabled = false; confirmBtn.textContent = 'Xác nhận đã thanh toán'; }
    
    if (qrModal) qrModal.style.display = 'none';
};

// Hàm xử lý thanh toán
window.processCheckout = function(chosenAddress) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    if (cart.length === 0) {
        alert('Giỏ hàng của bạn đang trống!');
        return;
    }
    localStorage.setItem('tempOrderAddress', chosenAddress);
    showQRModal();
};

//HÀM COMPLETEPAYMENT
window.completePayment = function() {
    const qrModal = document.getElementById('qrModal');
    const statusEl = document.getElementById('paymentStatus');
    if (countdownInterval) clearInterval(countdownInterval);
    
    try {
        // Lấy giỏ hàng
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const chosenAddress = localStorage.getItem('tempOrderAddress') || (currentUser ? currentUser.address : 'N/A');
        // Lấy thông tin người dùng hiện tại
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        if (cart.length > 0) {
            // Tính tổng tiền
            const totalK = cart.reduce((sum, it) => {
                const v = parseInt(String(it.price).replace(/[^\d]/g, ''), 10) || 0;
                return sum + v * (it.quantity || 1);
            }, 0);

            const allOrdersList = JSON.parse(localStorage.getItem('all_orders') || '[]');
            const newOrderId = `DH-${allOrdersList.length + 1}`;

            // Tạo đối tượng đơn hàng
            const order = {
                id: newOrderId,
                date: new Date().toISOString(),
                items: cart,
                total: totalK + 'k',
                // SỬA: Thêm thông tin người đặt hàng
                user: {
                    username: currentUser ? currentUser.username : 'Guest',
                    email: currentUser ? currentUser.email : 'N/A',
                    address: chosenAddress
                },
                status: 'Đang xử lý' // <-- THÊM TRẠNG THÁI MẶC ĐỊNH
            };

            // 1. Lưu vào lịch sử CÁ NHÂN của người dùng (như cũ)
            const userOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            userOrders.unshift(order); // newest first
            localStorage.setItem('orders', JSON.stringify(userOrders));

            // 2. THÊM MỚI: Lưu vào "kho" TRUNG TÂM cho Admin
            const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
            allOrders.unshift(order); 
            localStorage.setItem('all_orders', JSON.stringify(allOrders));
        }
        if (typeof updateStockAfterPurchase === 'function') {
                updateStockAfterPurchase(cart);
            }
    } catch (e) {
        console.error('Error saving order:', e);
    }
    
    // Xóa giỏ hàng (như cũ)
    localStorage.setItem('cart', '[]');
    localStorage.removeItem('tempOrderAddress');
    // Cập nhật badge (như cũ)
    if (typeof window.updateCartDisplay === 'function') {
        window.updateCartDisplay(); 
    }
    const badge = document.getElementById('floating-cart-badge');
    if (badge) {
        badge.textContent = '0';
        badge.style.display = 'none'; // Ẩn luôn số 0 đi cho đẹp
    }
    // Hiển thị thông báo (như cũ)
    statusEl.textContent = 'Thanh toán thành công! Cảm ơn bạn đã mua hàng.';
    statusEl.style.color = '#27ae60';
    updateStockAfterPurchase(cart);
    const confirmBtn = document.querySelector('.confirm-payment-btn');
    if (confirmBtn) { confirmBtn.disabled = true; confirmBtn.textContent = 'Đã xác nhận'; }
    
    document.querySelector('.cancel-payment-btn').textContent = 'Đóng';
    
    // Tải lại lịch sử nếu đang mở (như cũ)
    setTimeout(() => {
        if (qrModal) qrModal.style.display = 'none';
        const ordersModal = document.getElementById('ordersModal');
        if (ordersModal && ordersModal.style.display === 'flex') renderPurchaseHistory();
    }, 3000);
};
//thanh toán bằng tiền mặt
window.processCashPayment = function (chosenAddress) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) {
        alert('Giỏ hàng đang trống!');
        return;
    }

    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const totalK = cart.reduce((sum, it) => {
            const v = parseInt(String(it.price).replace(/[^\d]/g, ''), 10) || 0;
            return sum + v * (it.quantity || 1);
        }, 0);

        const allOrdersList = JSON.parse(localStorage.getItem('all_orders') || '[]');
        const newOrderId = `DH-${allOrdersList.length + 1}`;

        const order = {
            id: newOrderId,
            date: new Date().toISOString(),
            items: cart,
            total: totalK + "k",
            user: {
                username: currentUser ? currentUser.username : "Guest",
                email: currentUser ? currentUser.email : "N/A",
                address: chosenAddress,
            },
            status: "Chờ xử lý"
        };

        // Lưu cá nhân
        const userOrders = JSON.parse(localStorage.getItem('orders') || '[]');
        userOrders.unshift(order);
        localStorage.setItem('orders', JSON.stringify(userOrders));

        // Lưu admin
        const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
        allOrders.unshift(order);
        localStorage.setItem('all_orders', JSON.stringify(allOrders));
        updateStockAfterPurchase(cart);
        // Xóa giỏ
        localStorage.setItem('cart', '[]');

       if (typeof window.updateCartDisplay === 'function') {
        window.updateCartDisplay(); 
    }
    const badge = document.getElementById('floating-cart-badge');
    if (badge) {
        badge.textContent = '0';
        badge.style.display = 'none'; // Ẩn luôn số 0 đi cho đẹp
    }
        alert("Đặt hàng thành công! Bạn sẽ thanh toán khi nhận hàng.");
    
        // Nếu đang mở lịch sử thì reload
        const ordersModal = document.getElementById('ordersModal');
        if (ordersModal && ordersModal.style.display === 'flex') {
            renderPurchaseHistory();
        }

    } catch (err) {
        console.error("Lỗi thanh toán tiền mặt:", err);
    }
};

function renderPurchaseHistory() {
    const container = document.getElementById('ordersList');
    if (!container) return;
    
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        container.innerHTML = '<div class="empty-orders">Vui lòng đăng nhập.</div>';
        return;
    }

    // Lấy dữ liệu từ kho chung all_orders
    const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');

    // Lọc đơn của user hiện tại
    const myOrders = allOrders.filter(o => 
        o.user && o.user.username === currentUser.username
    );

    if (myOrders.length === 0) {
        container.innerHTML = '<div class="empty-orders">Bạn chưa có đơn hàng nào.</div>';
        return;
    }

    // Tạo bảng HTML
    let html = `
        <div class="table-responsive">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Mã ĐH</th>
                        <th>Ngày đặt</th>
                        <th class="address-cell">Địa chỉ</th>
                        <th>SL</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
    `;

    html += myOrders.map(o => {
        const totalQty = (o.items || []).reduce((sum, it) => sum + (it.quantity || 1), 0);
        const dateStr = o.date ? new Date(o.date).toLocaleDateString('vi-VN') : 'N/A';
        

        let statusClass = 'waiting';
        if (o.status === 'Đang giao') statusClass = 'delivering';
        if (o.status === 'Đã giao') statusClass = 'completed';
        if (o.status === 'Đã hủy') statusClass = 'cancelled';

        
        return `
            <tr onclick="showOrderDetails('${o.id}')" style="cursor: pointer;">
                <td style="font-weight:bold;">${o.id}</td>
                <td>${dateStr}</td>
                <td class="address-cell">${o.user.address || '---'}</td>
                <td>${totalQty}</td>
                <td class="price-text">${o.total}</td>
                <td><span class="status-badge ${statusClass}">${o.status || 'Chờ xử lý'}</span></td>
            </tr>
        `;
    }).join('');

    html += `</tbody></table></div>`;
    container.innerHTML = html;
}


// --- Thay thế hàm showOrderDetails cũ bằng hàm này ---

window.showOrderDetails = function(orderId) {
    // 1. Tìm đơn hàng
    const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
    const order = allOrders.find(o => o.id === orderId);
    
    if (!order) {
        console.error("Không tìm thấy đơn hàng:", orderId);
        return;
    }

    // 2. Điền tiêu đề
    const titleEl = document.getElementById('orderDetailsTitle');
    if (titleEl) titleEl.textContent = `Chi tiết đơn hàng ${orderId}`;
    
    // 3. Render danh sách sản phẩm (SỬ DỤNG CLASS CSS CÓ SẴN TRONG marketPage.css)
    const container = document.getElementById('orderDetailsContainer');
    if (container) {
        container.innerHTML = (order.items || []).map(item => `
            <div class="book-card-large">
                <div class="book-cover">
                    <img src="${item.image || '../assets/images/nhom.png'}" 
                         alt="${item.name}" 
                         onerror="this.src='../assets/images/nhom.png'" />
                </div>
                <div class="book-info">
                    <div class="book-name">${item.name}</div>
                    <div class="book-qty">
                        Số lượng: <strong>${item.quantity || 1}</strong>
                    </div>
                    <div class="book-price">
                        Giá: <strong>${item.price}</strong>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // 4. Hiển thị Modal
    const modal = document.getElementById('orderDetailsModal');
    if (modal) modal.style.display = 'flex';
};

// 3. HÀM ĐÓNG MODAL
window.closeOrderDetails = function() {
    const modal = document.getElementById('orderDetailsModal');
    if (modal) modal.style.display = 'none';
};

window.showPurchaseHistory = function() {
    const modal = document.getElementById('ordersModal');
    if (modal) {
        renderPurchaseHistory();
        modal.style.display = 'flex';
    }
};
window.closePurchaseHistory = function() {
    const modal = document.getElementById('ordersModal');
    if (modal) modal.style.display = 'none';
};
// ===== Hien thi noi dung market =====
let itemsPerPage = 8;
let currentPage = 1;
let searchQuery = "";


// Tải dữ liệu CHÍNH XÁC MỘT LẦN khi script chạy
const dataString = localStorage.getItem("adminProducts");
let marketItems = dataString ? JSON.parse(dataString) : market;
let filteredResults = [];

function clearFilters() {
  // Reset tất cả filter inputs
  document.getElementById('minPrice').value = '';
  document.getElementById('maxPrice').value = '';
  document.getElementById('releaseYear').value = '';
  // document.getElementById('searchInput').value = '';
  document.getElementById('selectedCategory').value = '';

  // Hiện thị tất cả item từ market
  filteredResults = [];
  // Giữ lại filter bằng tên 
  for (const category of Object.values(marketItems)) {
    let items = category.items;

    if (searchQuery.length > 0) {
      items = category.items.filter(item => 
       item.name.toLowerCase().includes(searchQuery.trim().toLowerCase())
      );
    }

    filteredResults.push(...items);
  }
  
  // Render full list starting from page 1
  renderMarketItems(1);
}


function applyFilters() {
    const minPrice = document.getElementById('minPrice').value.trim();
    const maxPrice = document.getElementById('maxPrice').value.trim();
    const releaseYear = document.getElementById('releaseYear').value.trim();
    
    // Lấy giá trị tìm kiếm từ cả 2 ô
    const mainSearch = document.getElementById('searchInput') ? document.getElementById('searchInput').value.trim().toLowerCase() : "";
    const filterSearch = document.getElementById('searchQuery') ? document.getElementById('searchQuery').value.trim().toLowerCase() : "";
    const searchQuery = mainSearch || filterSearch;
    
    const selectedCategory = document.getElementById('selectedCategory').value;

    filteredResults = [];
    for (const [categoryName, categoryData] of Object.entries(marketItems)) {
        if (selectedCategory && selectedCategory !== categoryName) continue;
        
        // === [QUAN TRỌNG] BỎ QUA NẾU DANH MỤC BỊ ADMIN ẨN ===
        if (categoryData.hidden === true) continue; 
        // ====================================================

        const items = categoryData.items.filter(item => {
            if(item.active === false) return false;
            const priceValue = parseInt(String(item.price).replace(/[^\d]/g, '')) || 0;
            const yearValue = parseInt(item.releaseYear);

            if (minPrice && priceValue < parseInt(minPrice)) return false;
            if (maxPrice && priceValue > parseInt(maxPrice)) return false;
            if (releaseYear && yearValue !== parseInt(releaseYear)) return false;
            if (searchQuery && !item.name.toLowerCase().includes(searchQuery)) return false;
            return true;
        });
        filteredResults.push(...items);
    }
    renderMarketItems(1);
}

document.getElementById("searchInput")?.addEventListener("input", function () {
    // Khi gõ vào ô chính, gọi hàm lọc chung chứ không tự lọc riêng
    applyFilters();
});


// Hiện thị item trong item-container
function renderMarketItems(page = 1) {
  const container = document.querySelector(".item-container");
  if (!container) return;
  
  container.innerHTML = "";

  const start = (page - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  let pageItems = filteredResults.slice(start, end); 

  pageItems.forEach(item => {
    const itemDiv = document.createElement("div");
    itemDiv.classList.add("market-item");
    itemDiv.innerHTML = `
    <div class="item-link">
      <div class="item-image">
          <img src="${item.image}" alt="${item.name}" />
      </div>

      <div class="item-info">
        <h3 class="item-name">${item.name}</h3>
        <p class="item-price">${formatK(item.price)}</p>
        <p class="item-quantity">Số lượng: ${item.quantity ?? 0}</p>
        <p class="item-release">Năm phát hành: ${item.releaseYear ?? "Không rõ"}</p>
      </div>
    </div>`;
    // --------------------------------
        
    itemDiv.addEventListener('click', (e) => {
        document.getElementById('quantity').value = 1;
        if (e.target.classList.contains('add-to-cart-btn') || 
            e.target.closest('.add-to-cart-btn')) {
            return;
        }
        showProductDetail(item);
    });

    container.appendChild(itemDiv);
  });

  renderPagination(filteredResults.length, page, itemsPerPage);
}
// Hiện thị thanh trang
function renderPagination(totalItems, currentPage, itemsPerPage) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const paginationContainer = document.querySelector(".pagination");
    paginationContainer.innerHTML = "";

    // 1. TÍNH TOÁN SỐ LƯỢNG NÚT DỰA TRÊN CHIỀU RỘNG MÀN HÌNH (RESPONSIVE)
    let maxButtons;
    const screenWidth = window.innerWidth;
    
    if (screenWidth > 1024) {
        maxButtons = 7; // Màn hình lớn/Desktop
    } else if (screenWidth > 600) {
        maxButtons = 5; // Tablet
    } else {
        maxButtons = 3; // Mobile
    }
    
    // Nếu số trang <= 1 thì ẩn thanh trang
    if (totalPages <= 1) {
        paginationContainer.style.display = "none";
        return;
    }
    paginationContainer.style.display = "flex";

    // Hàm tạo nút
    const createButton = (label, page, disabled = false, isEllipsis = false) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.disabled = disabled;
        btn.classList.add("page-btn");
        if (page === currentPage && !isEllipsis) btn.classList.add("active");
        
        if (isEllipsis) {
             btn.classList.add("ellipsis-btn"); 
             
             // LOGIC NHẢY KHỐI (BLOCK JUMPING) MỚI
             btn.addEventListener("click", () => {
                let jumpPage;
                
                // Nếu nút '...' nằm ở bên trái (page < currentPage) -> nhảy lùi
                if (page < currentPage) {
                    // Nhảy lùi một khối (maxButtons)
                    jumpPage = Math.max(1, currentPage - maxButtons); 
                } 
                // Nếu nút '...' nằm ở bên phải (page > currentPage) -> nhảy tiến
                else {
                    // Nhảy tiến một khối (maxButtons)
                    jumpPage = Math.min(totalPages, currentPage + maxButtons);
                }
                
                // Chỉ chuyển trang nếu trang đích khác trang hiện tại
                if (jumpPage !== currentPage) {
                    renderMarketItems(jumpPage);
                }
             });
        } else {
             btn.addEventListener("click", () => {
                renderMarketItems(page);
             });
        }
        return btn;
    };

    // 2. Nút PREVIOUS
    paginationContainer.appendChild(createButton("Previous", currentPage - 1, currentPage === 1));

    
    let startPage = 1;
    let endPage = totalPages;

    // Logic rút gọn dãy số trang (sử dụng maxButtons đã tính toán)
    if (totalPages > maxButtons) {
        // Luôn giữ trang hiện tại ở giữa
        const half = Math.floor(maxButtons / 2);
        
        startPage = currentPage - half;
        endPage = currentPage + half;

        // Xử lý tràn lề trái
        if (startPage < 1) {
            startPage = 1;
            endPage = maxButtons;
        }

        // Xử lý tràn lề phải
        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = totalPages - maxButtons + 1;
        }
        // Đảm bảo startPage không nhỏ hơn 1 
        if (startPage < 1) startPage = 1; 
    }
    
    // 3. Hiển thị trang đầu tiên và dấu "..." bên trái nếu cần
    if (startPage > 1) {
        paginationContainer.appendChild(createButton(1, 1));
        if (startPage > 2) {
            // Giá trị page 1 được sử dụng để xác định đây là '...' bên trái (page < currentPage)
            paginationContainer.appendChild(createButton("...", 1, false, true)); 
        }
    }

    // 4. Các nút số trang chính
    for (let i = startPage; i <= endPage; i++) {
        paginationContainer.appendChild(createButton(i, i));
    }

    // 5. Hiển thị trang cuối cùng và dấu "..." bên phải nếu cần
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            // Giá trị page totalPages được sử dụng để xác định đây là '...' bên phải (page > currentPage)
            paginationContainer.appendChild(createButton("...", totalPages, false, true)); 
        }
        paginationContainer.appendChild(createButton(totalPages, totalPages));
    }

    // 6. Nút NEXT
    paginationContainer.appendChild(createButton("Next", currentPage + 1, currentPage === totalPages));
}

function showProductDetail(item) {
    const productDetail = document.querySelector(".product-container");
    if (!productDetail || !item) return;

    // Gán dữ liệu sản phẩm vào popup
    const productImage = document.getElementById("product-image");
    const productName = document.getElementById("product-name");
    const productPrice = document.getElementById("product-price");
    const productQuantity = document.getElementById("product-quantity");
    const productYear = document.getElementById("product-year");
    const productDescription = document.getElementById("product-description");

  if (productImage) productImage.src = item.image;
  if (productName) productName.textContent = item.name;
  if (productPrice) productPrice.textContent = formatK(item.price);
  if (productQuantity) productQuantity.textContent = item.quantity ?? 0;
    if (productYear) productYear.textContent = item.releaseYear ?? "Không rõ";
    if (productDescription) productDescription.textContent = item.description;

    // Reset số lượng về 1
    const quantityInput = document.getElementById("quantity");
    if (quantityInput) quantityInput.value = 1;

    // Hiện popup chi tiết sản phẩm
    productDetail.classList.add("active");

  // Định nghĩa hàm thêm vào giỏ hàng từ popup
  window.addToCartPopup = function() {
        const quantity = parseInt(document.getElementById("quantity").value) || 1;
        
        // Sử dụng hàm addToCart toàn cục
        addToCart(item, quantity); 

        // Đóng popup chi tiết sản phẩm
        productDetail.classList.remove("active");
  };

    // Định nghĩa các hàm xử lý số lượng
    window.decreaseQuantity = function() {
        const input = document.getElementById("quantity");
        if (!input) return;
        let value = parseInt(input.value);
        if (value > 1) {
            input.value = value - 1;
        }
    };

    window.increaseQuantity = function() {
        const input = document.getElementById("quantity");
        if (!input) return;
        let value = parseInt(input.value);
        let maxQuantity = parseInt(document.getElementById("product-quantity").textContent);
        if (value < maxQuantity) {
            input.value = value + 1;
        }
    };

    window.validateQuantity = function(input) {
        let value = parseInt(input.value);
        let maxQuantity = parseInt(document.getElementById("product-quantity").textContent);
        if (value < 1) input.value = 1;
        if (value > maxQuantity) input.value = maxQuantity;
    };

    // Thêm sự kiện click để đóng popup khi click ngoài
    const closePopup = function(event) {
        // Điều kiện: click bên ngoài popup VÀ không phải click vào 1 ".market-item" khác
        if (!productDetail.contains(event.target) && 
            !event.target.closest('.market-item')) {
productDetail.classList.remove("active");
            document.removeEventListener('click', closePopup, true); // Bắt sự kiện ở phase capture
        }
    };

    // Đợi một chút (để sự kiện click hiện tại kết thúc)
    setTimeout(() => {
        document.addEventListener('click', closePopup, true);
    }, 100);
}

// ===== LẮNG NGHE ADMIN THAY ĐỔI =====
window.addEventListener('storage', (event) => {
    
    const adminKeys = [
        'adminProducts',
        'users',         
        'adminImports',
        'all-orders' 
    ];

    if (adminKeys.includes(event.key)) {
        location.reload();
    }
    if (event.key === 'orders') {
        const ordersModal = document.getElementById('ordersModal');
        // Chỉ render lại nếu modal lịch sử đang mở
        if (ordersModal && ordersModal.style.display === 'flex') {
            // Gọi lại hàm render để cập nhật trạng thái mới
            renderPurchaseHistory(); 
        }
    }
});


//Hiển thị lịch sử mua hàng
const historyBtn = document.getElementById('show-history-btn');
if (historyBtn) {
    historyBtn.addEventListener('click', (e) => {
        e.preventDefault(); 
        
        // 1. Gọi hàm hiển thị lịch sử (đã được định nghĩa ở trên)
        if (typeof window.showPurchaseHistory === 'function') {
            window.showPurchaseHistory();
        }

        // 2. Đóng dropdown
        const dropdown = document.getElementById('dropdownMenu');
        if (dropdown) {
            dropdown.classList.remove('show');
        }

        // 3. Đóng sidebar (nếu đang ở mobile)
        // (Phụ thuộc vào việc sửa navbar.js để expose `closeSidebar`)
        const media = window.matchMedia("(width < 700px)");
        if (media.matches && typeof window.closeSidebar === 'function') {
            window.closeSidebar();
        }
    });
}

// ===== XỬ LÝ MỞ POPUP TỪ HOME PAGE =====
// (Chúng ta di chuyển code này xuống đây để nó chạy cùng cụm)
const urlParams = new URLSearchParams(window.location.search);
const productName = urlParams.get('product');

if (productName) {
    const decodedName = decodeURIComponent(productName);
    
    if (marketItems) {
        let foundProduct = null;
        Object.values(marketItems).forEach(category => {
            if (category.items) {
                const product = category.items.find(item => item.name === decodedName);
                if (product) foundProduct = product;
            }
        });
        
        if (foundProduct) {
            setTimeout(() => {
                showProductDetail(foundProduct);
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 500);
        }
    }
}

const searchInput = document.getElementById("searchInput");
if (searchInput) { 
	searchInput.addEventListener("input", e => {
	searchQuery = e.target.value.trim();
  applyFilters();
	renderMarketItems(1);
	});
}

// Thay đổi các hiện thị khi window bị thay đổi khích thước
window.addEventListener("resize", () => {
   	renderMarketItems(1); // Re-render on resize
});


// ===== SỰ KIỆN NÚT FILTER =====
document.querySelector('.filter-button')?.addEventListener('click', function () {
  const panel = document.getElementById('filter-panel');
  if (!panel) {
    console.warn('Không tìm thấy phần tử #filter-panel trong HTML.');
    return;
  }

  // Toggle visibility
  panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
});

// Load lại trang
document.addEventListener("DOMContentLoaded", () => {
  const latestData = localStorage.getItem("adminProducts");
  // Nếu chưa có trong storage thì dùng biến market mặc định
  const currentMarketData = latestData ? JSON.parse(latestData) : market; 


  filteredResults = [];
  
  for (const category of Object.values(currentMarketData)) {
    // bỏ qua các danh mục bị ẩn
    if (category.hidden === true) continue; 
    //chỉ lấy sản phẩm được hiện và ko bị xóa
    if (category.items) {
        const activeItems = category.items.filter(item => item.active !== false);
        filteredResults.push(...activeItems);
    }
  }
  
  // Render trang 1
  renderMarketItems(1);

  // Bind filter button
  const filterBtn = document.querySelector('.filter-button');
  const filterPanel = document.getElementById('filter-panel');
  const applyBtn = document.getElementById('apply-filter-button');
  const clearBtn = document.getElementById('clear-filter-button');
  

  const categorySelect = document.getElementById('selectedCategory');
  if (categorySelect) {
    categorySelect.innerHTML = ''; 
    const allOption = document.createElement('option');
    allOption.value = "";
    allOption.textContent = "Tất cả";
    categorySelect.appendChild(allOption);

    Object.keys(marketItems).forEach(cat => {

        if (marketItems[cat].hidden === true) return;
        
        const option = document.createElement('option');
        option.value = cat; 
        option.textContent = cat;
        categorySelect.appendChild(option);
    });
  }


  if (applyBtn) {
    applyBtn.addEventListener('click', applyFilters);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', clearFilters);
  }

  // Close filter panel when clicking outside
  document.addEventListener('click', (event) => {
    const isClickInsidePanel = filterPanel.contains(event.target);
    const isClickOnButton = filterBtn.contains(event.target);

    if (!isClickInsidePanel && !isClickOnButton) {
      filterPanel.style.display = 'none';
    }
  });
  updateCartBadge()
  // ======== FIX SEARCH KHÔNG RELOAD ========

// Ngăn form tự submit
document.querySelector(".search-bar")?.addEventListener("submit", function(e) {
    e.preventDefault();
});

// Lắng nghe search realtime
document.getElementById("searchInput")?.addEventListener("input", function () {
    const keyword = this.value.trim().toLowerCase();

    filteredResults = [];

    const searchData = localStorage.getItem("adminProducts") ? JSON.parse(localStorage.getItem("adminProducts")) : (typeof marketItems !== 'undefined' ? marketItems : {});
    for (const category of Object.values(searchData)) {
      if (category.hidden === true) continue; 
        const items = category.items.filter(item =>
            item.active!=false &&
            item.name.toLowerCase().includes(keyword)
        );
        filteredResults.push(...items);
    }

    // render trang 1 khi search
    renderMarketItems(1);
});

});

// Biến tạm để lưu trữ hàm thanh toán (QR hoặc Cash)
let pendingPaymentFunction = null;

// Hàm mở Modal Địa chỉ 
window.showAddressModal = function(paymentFunction) {
    // Lấy thông tin người dùng hiện tại
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));

    //  KIỂM TRA ĐĂNG NHẬP ===
    if (!currentUser) {
        if(confirm("Bạn cần đăng nhập để thực hiện thanh toán. Đi đến trang đăng nhập ngay?")) {
            // Kiểm tra xem đang ở trang nào để chuyển hướng đúng đường dẫn
            const currentPath = window.location.pathname;
            if (currentPath.includes('/pages/')) {
                // Đang ở trong thư mục pages (ví dụ market.html)
                window.location.href = 'auth.html';
            } else {
                // Đang ở trang chủ (index.html)
                window.location.href = 'pages/auth.html';
            }
        }
        return; //không mở modal địa chỉ
    }
    // =====================================

    //Lưu lại hàm thanh toán sẽ gọi sau
    pendingPaymentFunction = paymentFunction;
    
    const modal = document.getElementById('addressModal');
    const defaultRadio = document.getElementById('useDefaultAddress');
    const defaultLabel = document.getElementById('defaultAddressLabel');
    const newRadio = document.getElementById('useNewAddress');
    const newAddressInput = document.getElementById('newAddressInput');

    //Tải địa chỉ mặc định (nếu có)
    if (currentUser && currentUser.address && currentUser.address.trim() !== "") {
        defaultLabel.textContent = `Sử dụng địa chỉ mặc định: ${currentUser.address}`;
        defaultRadio.disabled = false;
        defaultRadio.checked = true;
        newRadio.checked = false;
    } else {
        // Nếu không có địa chỉ mặc định, ép người dùng nhập địa chỉ mới
        defaultLabel.textContent = "Không có địa chỉ mặc định (Vui lòng nhập địa chỉ mới)";
        defaultRadio.disabled = true;
        defaultRadio.checked = false;
        newRadio.checked = true;
    }
    
    //Reset và hiển thị modal
    newAddressInput.value = '';
    if(modal) modal.style.display = 'flex';
};

// Hàm đóng Modal Địa chỉ
window.closeAddressModal = function() {
    document.getElementById('addressModal').style.display = 'none';
    pendingPaymentFunction = null; // Hủy hàm đang chờ
}

// Hàm xác nhận địa chỉ 
window.handleAddressConfirmation = function() {
    const useDefault = document.getElementById('useDefaultAddress').checked;
    const newAddress = document.getElementById('newAddressInput').value.trim();
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    let chosenAddress = "";

    if (useDefault) {
        chosenAddress = currentUser.address;
    } else {
        chosenAddress = newAddress;
    }

    // Kiểm tra xem người dùng đã chọn/nhập địa chỉ chưa
    if (!chosenAddress || chosenAddress.trim() === "") {
        alert('Vui lòng cung cấp địa chỉ giao hàng!');
        return;
    }
    
    // Đóng modal địa chỉ
    const paymentAction=pendingPaymentFunction;
    closeAddressModal();
    
    // Gọi hàm thanh toán (QR hoặc Cash) đã lưu
    // và TRUYỀN địa chỉ đã chọn vào
    if (typeof paymentAction === 'function') {
        paymentAction(chosenAddress);
    }
}
function updateStockAfterPurchase(cart) {
    //Lấy dữ liệu kho mới nhất từ localStorage (hoặc dùng marketItems hiện tại)
    const currentData = JSON.parse(localStorage.getItem("adminProducts")) || marketItems;
    if (!currentData) return;

    // Duyệt qua từng món trong giỏ hàng để trừ kho
    cart.forEach(cartItem => {
        Object.values(currentData).forEach(category => {
            // Tìm sản phẩm khớp tên
            const product = category.items.find(p => p.name === cartItem.name);
            if (product) {
                // Trừ số lượng
                product.quantity = Math.max(0, product.quantity - cartItem.quantity);
            }
        });
    });

    // Lưu ngược lại vào localStorage
    localStorage.setItem("adminProducts", JSON.stringify(currentData));

    //CẬP NHẬT BIẾN TOÀN CỤC & GIAO DIỆN
    // Cập nhật biến marketItems đang chạy trong ram
    marketItems = currentData; 

    // Gọi hàm lọc để tính toán lại danh sách hiển thị (filteredResults) và reset về trang 1
    if (typeof applyFilters === 'function') {
        applyFilters(); 
    } else {
        // Fallback nếu không có hàm applyFilters
        renderMarketItems(1);
    }
}
